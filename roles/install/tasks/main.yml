---
- name: "Ensure APT cache is up-to-date"
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600

- name: "Upgrade all packages to latest"
  ansible.builtin.apt:
    upgrade: dist
    autoremove: true
    autoclean: true

- name: "Install core packages"
  block:
    - name: "Install core packages"
      ansible.builtin.apt:
        name: "{{ install_core }}"
        state: present
        update_cache: false
      when: install_core is defined and install_core | length > 0
  rescue:
    - name: "⚠️ Core packages failed, continuing"
      ansible.builtin.debug:
        msg: "Installation of core packages ({{ install_core }}) failed."

- name: "Install networking tools"
  block:
    - name: "Install networking tools"
      ansible.builtin.apt:
        name: "{{ install_networking }}"
        state: present
      when: install_networking is defined and install_networking | length > 0
  rescue:
    - name: "⚠️ Networking tools failed, continuing"
      ansible.builtin.debug:
        msg: "Installation of networking packages ({{ install_networking }}) failed."

- name: "Install monitoring utilities"
  block:
    - name: "Install monitoring utilities"
      ansible.builtin.apt:
        name: "{{ install_monitoring }}"
        state: present
      when: install_monitoring is defined and install_monitoring | length > 0
  rescue:
    - name: "⚠️ Monitoring utilities failed, continuing"
      ansible.builtin.debug:
        msg: "Installation of monitoring packages ({{ install_monitoring }}) failed."

- name: "Install miscellaneous packages"
  block:
    - name: "Install miscellaneous packages"
      ansible.builtin.apt:
        name: "{{ install_misc }}"
        state: present
      when: install_misc is defined and install_misc | length > 0
  rescue:
    - name: "⚠️ Misc tools failed, continuing"
      ansible.builtin.debug:
        msg: "Installation of misc packages ({{ install_misc }}) failed."
